(function(d,b,a,g){var c="gantt",f={mode:"regular",modes:{regular:{scale:2,paddingX:2,paddingY:1,showContent:true},collapsed:{scale:0.3,paddingX:0,paddingY:0.3,showContent:false}},position:{date:null,top:0},view:"year",views:{week:{grid:{color:"#DDD",x:150,y:10},format:"MMM, DD",labelEvery:"day",preloadDays:200,dayOffset:1,highlightDays:10},month:{grid:{color:"#DDD",x:42,y:10},format:"MMM, DD",labelEvery:"day",preloadDays:150,dayOffset:3,highlightDays:10},year:{grid:{color:"#DDD",x:13,y:10},format:"MMM",labelEvery:"month",preloadDays:100,dayOffset:5,highlightDays:10}}};function e(k,j,h){var l=this;l.container=d(k);l.options=d.extend({},f,h);l.projects=j;l.init()}e.prototype={init:function(){var h=this;h.parseProjects();h.createUI();h.render();h.drawGrid();h.createEvents()},parseProjects:function(){var h=this.projects,j=null;for(i=0;i<h.length;i++){j=h[i];if(isNaN(j.startDate)){j.startDate=moment(j.startDate).unix();j.endDate=moment(j.endDate).unix()}j.ganttRow=0}h.sort(function(l,k){return l.startDate-k.startDate})},createUI:function(){var k=this,j=k.container,h='<div class="jg-viewport"><div class="jg-timeline"><div class="jg-labels"></div><div class="jg-content"></div></div><div class="jg-playhead"></div><canvas class="jg-grid"></canvas></div>';j.append(h);k.content=j.find(".jg-content");k.grid=j.find(".jg-grid");k.labels=j.find(".jg-labels");k.playhead=j.find(".jg-playhead");k.timeline=j.find(".jg-timeline");k.viewport=j.find(".jg-viewport")},render:function(){var h=this;console.time("render time");h.clearUI();h.setGlobals();h.setActiveProjects();h.setPosition();h.drawLabels();h.createElements();h.dragInit();console.timeEnd("render time")},clearUI:function(){var h=this;h.content.empty();h.labels.empty()},setGlobals:function(){var m=this,k=m.options,l=m.container;m.mode=k.modes[k.mode];m.view=k.views[k.view];m.containerWidth=l.width();m.timelineWidth=m.containerWidth*3;m.viewportHeight=l.height()-m.labels.height();var j=k.position.date,h=m.view.grid.x;m.daysUntilCurrent=Math.floor(m.containerWidth/h);m.daysInGrid=Math.floor(m.timelineWidth/m.view.grid.x);m.curMoment=j?moment(j):moment();m.startMoment=moment(m.curMoment).subtract("days",m.daysUntilCurrent);m.endMoment=moment(m.startMoment).add("days",m.daysInGrid);m.dayOffset=m.view.dayOffset*h},setActiveProjects:function(){var n=this,r=n.options,o=n.view,m=n.projects,l=(o.preloadDays*24*60*60),p=n.startMoment.unix()-l,h=n.endMoment.unix()+l;n.activeProjects=[];for(i=0;i<m.length;i++){var q=m[i],j=n.isBetween(p,q.startDate,h),k=n.isBetween(p,q.endDate,h);if(j||k){n.activeProjects.push(q)}}},drawGrid:function(){var n=this,m=this.options,l=n.grid[0],k=l.getContext("2d"),j=m.views[m.view],h=j.grid.x,o=j.grid.y;l.height=o;l.width=h;k.moveTo(h-0.5,-0.5);k.lineTo(h-0.5,o-0.5);k.lineTo(-0.5,o-0.5);k.strokeStyle=j.grid.color;k.stroke();data=l.toDataURL("image/jpg");n.content.css({background:"url("+data+")"})},setPosition:function(){var o=this,k=o.options,j=o.view,h=j.grid.x,n=o.dayOffset,l=-(o.daysUntilCurrent*h)+n,m=n;o.timeline.css({marginLeft:l,width:o.timelineWidth});o.playhead.css({left:m,width:(j.highlightDays*h)})},drawLabels:function(){var m=this,q=m.options,o=m.view,l=o.grid.x,k=[],p=null;for(var j=0;j<m.daysInGrid;j++){var n=moment(m.startMoment).add("days",j),h=false;switch(o.labelEvery){case"month":if(n.format("D")==="1"){h=true}break;default:h=true}if(h){p='<div class="jg-label" style="left:'+(l*j)+"px;width:"+l+'px;"><div class="jg-'+q.view+'">'+n.format(o.format)+"</div></div>";k.push(p)}}m.labels.append(k.join(""))},createElements:function(){var N=this,n=N.options,y=N.mode,w=N.view,L=w.grid.x,H=w.grid.y,t=N.activeProjects,z=[],u=H*y.scale-1,G=H*y.paddingY,J=y.paddingX*(24*60*60),C=0;for(var I=0;I<t.length;I++){var m=t[I],l=moment.unix(m.startDate),M=moment.unix(m.endDate),O=M.diff(l,"days")+1,v=l.diff(N.startMoment,"days"),o=O*L-1,x=v*L,B,P=l.unix()-J,K=M.unix()+J,r=0,p=[];for(var F=0;F<I;F++){var h=t[F],A=h.startDate,q=h.endDate;if(N.isBetween(A,P,q)){p.push(h.ganttRow)}else{if(N.isBetween(P,q,K)){p.push(h.ganttRow)}else{if(N.isBetween(A,K,q)){p.push(h.ganttRow)}else{if(N.isBetween(P,A,K)){p.push(h.ganttRow)}}}}}p.sort(function(k,j){return k-j});for(var E=0;E<p.length;E++){usedRow=p[E];if(r===usedRow){r++}}if(r>C){C=r}m.ganttRow=r;B=G+(r*(u+G+1));z.push('<div class="jg-project" style="height:'+u+"px;left:"+x+"px;top: "+B+"px;width:"+o+'px;"><div class="jg-data" style="background:'+m.color+';">');if(y.showContent){z.push('<img class="jg-icon" src="'+m.iconURL+'" style="height: '+u+";width: "+u+';" /><div class="jg-name" style="width: '+(o-u-8)+'px;">'+m.name+'</div><div class="jg-tasks">');for(F=0;F<m.tasks.length;F++){var s=m.tasks[F],D=moment(l).diff(s.date,"days")*L;z.push('<div class="jg-task" style="left:'+D+'px;"></div>')}z.push("</div></div>")}else{z.push("</div>")}z.push("</div>")}C++;content_height=(C*H)+(C*u)+H;if(content_height<N.viewportHeight){content_height=N.viewportHeight;N.content.animate({marginTop:0},100)}else{if(content_height<N.content.height()){N.content.animate({marginTop:N.viewportHeight-content_height},100)}}N.content.append(z.join("")).css({height:content_height})},dragInit:function(){var p=this,t=p.options,h=p.content,k=p.timeline,m=p.viewportHeight,q=p.view,n=q.grid.x,o=positions={x:0,y:0},s=draggingX=draggingY=false,j=curMoment=null,r=null,l=10;p.viewport.off().on("mousedown mousemove mouseup",function(y){if(y.type==="mousedown"){s=true;o={x:y.pageX,y:y.pageY};positions={x:parseInt(k.css("margin-left")),y:parseInt(h.css("margin-top"))};var v=Math.round(parseInt(k.css("margin-left"))/n);j=moment(p.startMoment).subtract("days",v);r=h.height()}else{if(y.type==="mousemove"&&s){if(!draggingX&&!draggingY){if(Math.abs(y.pageX-o.x)>l){draggingX=true}else{if(Math.abs(y.pageY-o.y)>l){draggingY=true}}}else{if(draggingX){var x=positions.x+(y.pageX-o.x);k.css({marginLeft:x})}else{var w=positions.y+(y.pageY-o.y),u=-(r-m);if(w>0){w=0}if(w<u){w=u}h.css({marginTop:w})}}}else{if(y.type==="mouseup"){s=draggingX=draggingY=false;var v=Math.round((parseInt(k.css("margin-left"))-p.dayOffset)/n);curMoment=moment(p.startMoment).subtract("days",v);if(curMoment.format("MM DD")!=j.format("MM DD")){t.position.date=curMoment;t.position.top=parseInt(h.css("margin-top"));p.render()}}}}})},createEvents:function(){var k=this,h=k.options,j=k.container;j.off("gantt-changeView").on("gantt-changeView",function(m,l){h.view=l;k.render()});j.off("gantt-collapse").on("gantt-collapse",function(){if(h.mode==="collapsed"){h.mode="regular"}else{h.mode="collapsed"}k.render()});d(".jg-project").off().on("mouseenter mouseleave",function(l){if(l.type==="mouseenter"){d(this).find(".jg-tasks").animate({top:20},100)}else{d(this).find(".jg-tasks").animate({top:0},100)}})},isBetween:function(k,h,j){return(k<=h&&h<=j)}};d.fn[c]=function(j,h){return this.each(function(){if(!d.data(this,"plugin_"+c)){d.data(this,"plugin_"+c,new e(this,j,h))}})}})(jQuery,window,document);