(function(d,b,a,g){var c="gantt",f={filter:{},mode:"regular",modes:{regular:{scale:2,paddingX:2,paddingY:1,showContent:true},collapsed:{scale:0.3,paddingX:0,paddingY:0.3,showContent:false}},position:{date:null,top:0},view:"year",views:{week:{grid:{color:"#DDD",x:150,y:10},format:"MMM DD",labelEvery:"day",preloadDays:30,dayOffset:1,highlightDays:7},month:{grid:{color:"#DDD",x:42,y:10},format:"MMM DD",labelEvery:"day",preloadDays:30,dayOffset:3,highlightDays:10},year:{grid:{color:"#DDD",x:13,y:10},format:"MMM",labelEvery:"month",preloadDays:30,dayOffset:5,highlightDays:10}}};function e(k,j,h){var l=this;l.container=d(k);l.options=d.extend({},f,h);l.projects=j;l.init()}e.prototype={init:function(){var h=this;h.parseProjects();h.createUI();h.render()},parseProjects:function(){var h=this.projects,j=null;for(i=0;i<h.length;i++){j=h[i];if(isNaN(j.startDate)){j.startDate=moment(j.startDate).unix();j.endDate=moment(j.endDate).unix()}j.ganttRow=0}h.sort(function(l,k){return l.startDate-k.startDate})},createUI:function(){var k=this,j=k.container,h='<div class="jg-viewport"><div class="jg-timeline"><div class="jg-dates"></div><div class="jg-content-wrap"><div class="jg-glow-top"></div><div class="jg-content"></div><div class="jg-glow-bottom"></div></div></div><div class="jg-playhead"></div><canvas class="jg-grid"></canvas></div>';j.empty().append(h);k.contentWrap=j.find(".jg-content-wrap");k.glowTop=j.find(".jg-glow-top");k.glowBottom=j.find(".jg-glow-bottom");k.content=j.find(".jg-content");k.dates=j.find(".jg-dates");k.grid=j.find(".jg-grid");k.playhead=j.find(".jg-playhead");k.timeline=j.find(".jg-timeline");k.viewport=j.find(".jg-viewport")},render:function(){var h=this;console.time("render time");h.clearUI();h.setGlobals();h.setActiveProjects();h.drawGrid();h.setPosition();h.drawLabels();h.createElements();h.dragInit();h.setNamePositions();h.setVerticalHints();h.createEvents();console.timeEnd("render time")},clearUI:function(){var h=this;h.content.empty();h.dates.empty()},setGlobals:function(){var m=this,k=m.options,l=m.container;m.mode=k.modes[k.mode];m.view=k.views[k.view];m.containerWidth=l.width();m.timelineWidth=m.containerWidth*3;m.viewportHeight=l.height()-m.dates.height();var j=k.position.date,h=m.view.grid.x;m.daysUntilCurrent=Math.floor(m.containerWidth/h);m.daysInGrid=Math.floor(m.timelineWidth/m.view.grid.x);m.curMoment=j?moment(j):moment();m.startMoment=moment(m.curMoment).subtract("days",m.daysUntilCurrent);m.endMoment=moment(m.startMoment).add("days",m.daysInGrid);m.dayOffset=m.view.dayOffset*h;m.settingNamePositions=false},setActiveProjects:function(){var q=this,u=q.options,r=q.view,p=q.projects,n=(r.preloadDays*24*60*60),s=q.startMoment.unix()-n,h=q.endMoment.unix()+n;q.activeProjects=[];for(i=0;i<p.length;i++){var t=p[i],k=q.isBetween(s,t.startDate,h),l=q.isBetween(s,t.endDate,h),m=true;for(filter in u.filter){m=false;theFilter=u.filter[filter];for(var o=0;o<theFilter.length;o++){if(t[filter]===theFilter[o]){m=true}}}if((k||l)&&m){q.activeProjects.push(t)}}},drawGrid:function(){var n=this,m=this.options,l=n.grid[0],k=l.getContext("2d"),j=m.views[m.view],h=j.grid.x,o=j.grid.y;l.height=o;l.width=h;k.moveTo(h-0.5,-0.5);k.lineTo(h-0.5,o-0.5);k.lineTo(-0.5,o-0.5);k.strokeStyle=j.grid.color;k.stroke();data=l.toDataURL("image/jpg");n.content.css({background:"url("+data+")"})},setPosition:function(){var o=this,k=o.options,j=o.view,h=j.grid.x,n=o.dayOffset,l=-(o.daysUntilCurrent*h)+n,m=n;o.timeline.css({left:l,width:o.timelineWidth});o.glowBottom.css({top:o.viewportHeight-o.glowBottom.height()});o.playhead.css({left:m,width:(j.highlightDays*h)})},drawLabels:function(){var l=this,q=l.options,n=l.view,k=n.grid.x,j=[],o=null;for(var h=0;h<l.daysInGrid;h++){var m=moment(l.startMoment).add("days",h),p=false;switch(n.labelEvery){case"month":if(m.format("D")==="1"){p=n.format}break;default:p=n.format}if(p&&moment().format("YYYY")!=m.format("YYYY")){p+=", YYYY"}if(p){o='<div class="jg-label" style="left:'+(k*h)+"px;width:"+k+'px;"><div class="jg-'+q.view+'">'+m.format(p)+"</div></div>";j.push(o)}}l.dates.append(j.join(""))},createElements:function(){var O=this,n=O.options,y=O.mode,w=O.view,L=w.grid.x,H=w.grid.y,t=O.activeProjects,z=[],u=H*y.scale-1,G=H*y.paddingY,J=y.paddingX*(24*60*60),C=0;for(var I=0;I<t.length;I++){var m=t[I],l=moment.unix(m.startDate),M=moment.unix(m.endDate),P=M.diff(l,"days")+1,v=l.diff(O.startMoment,"days"),o=P*L-1,x=v*L,B,Q=l.unix()-J,K=M.unix()+J,r=0,p=[];for(var F=0;F<I;F++){var h=t[F],A=h.startDate,q=h.endDate;if(O.isBetween(A,Q,q)){p.push(h.ganttRow)}else{if(O.isBetween(Q,q,K)){p.push(h.ganttRow)}else{if(O.isBetween(A,K,q)){p.push(h.ganttRow)}else{if(O.isBetween(Q,A,K)){p.push(h.ganttRow)}}}}}p.sort(function(k,j){return k-j});for(var E=0;E<p.length;E++){usedRow=p[E];if(r===usedRow){r++}}if(r>C){C=r}m.ganttRow=r;B=G+(r*(u+G+1));z.push('<div class="jg-project" style="height:'+u+"px;left:"+x+"px;top: "+B+"px;z-index:"+(1000-r)+";width:"+o+'px;"><div class="jg-data" style="background:'+m.color+';">');if(y.showContent){z.push('<div class="jg-name"><img class="jg-icon" src="'+m.iconURL+'" />'+m.name+"</div>")}z.push("</div>");if(y.showContent){z.push('<div class="jg-tasks">');var s=(L/2)-2;for(F=0;F<m.tasks.length;F++){var N=m.tasks[F],D=(moment(l).diff(N.date,"days",true)*L)+s;z.push('<div class="jg-task" style="left:'+D+'px;"></div>')}z.push("</div>")}z.push("</div>")}C+=2;content_height=(C*H)+(C*u)+H;content_offset=-(O.content.position().top);if(content_height<O.viewportHeight){content_height=O.viewportHeight;O.content.animate({top:0},100)}else{if(content_height<content_offset+O.viewportHeight){O.content.animate({top:O.viewportHeight-content_height},100)}}O.content.append(z.join("")).css({height:content_height})},dragInit:function(){var p=this,t=p.options,h=p.content,k=p.timeline,m=p.viewportHeight,q=p.view,n=q.grid.x,o=positions={x:0,y:0},s=draggingX=draggingY=false,j=curMoment=null,r=null,l=10;p.viewport.off().on("mousedown mousemove mouseup",function(y){if(y.type==="mousedown"){s=true;o={x:y.pageX,y:y.pageY};positions={x:k.position().left,y:p.content.position().top};var v=Math.round(k.position().left/n);j=moment(p.startMoment).subtract("days",v);r=h.height()}else{if(y.type==="mousemove"&&s){if(!draggingX&&!draggingY){if(Math.abs(y.pageX-o.x)>l){draggingX=true}else{if(Math.abs(y.pageY-o.y)>l){draggingY=true}}}else{if(draggingX){var x=positions.x+(y.pageX-o.x);k.css({left:x});p.setNamePositions()}else{var w=positions.y+(y.pageY-o.y),u=-(r-m);if(w>0){w=0}if(w<u){w=u}h.css({top:w});p.setVerticalHints()}}}else{if(y.type==="mouseup"){s=draggingX=draggingY=false;var v=Math.round((k.position().left-p.dayOffset)/n);curMoment=moment(p.startMoment).subtract("days",v);if(moment(curMoment).subtract("days",p.view.dayOffset).format("MM DD")!=j.format("MM DD")){t.position.date=curMoment;t.position.top=p.content.position().top;p.render()}}}}})},setNamePositions:function(){var p=this;if(p.mode.showContent){var h=d(".jg-project"),q=-(p.timeline.position().left),j=false;for(var m=0;m<h.length;m++){var n=d(h[m]),l=n.position().left;if(l<q+500){var o=n.width();if(l+o>q-500){var r=n.find(".jg-name"),k=o-(q-l);if(k<=o){r.width(k)}else{r.width(o)}}j=true}else{if(j){return false}}}}},setVerticalHints:function(){var l=this,k=-(l.content.position().top),h=l.content.height()-k-l.viewportHeight,j=100;if(k>j){k=j}if(h>j){h=j}k=k/20;h=h/20;l.glowTop.css({boxShadow:"inset 0 "+k+"px "+(k*1.5)+"px 0 rgba(0,0,0,0.35)"});l.glowBottom.css({boxShadow:"inset 0 -"+h+"px "+(h*1.5)+"px 0 rgba(0,0,0,0.35)"})},createEvents:function(){var k=this,h=k.options,j=k.container;j.off("gantt-moveto").on("gantt-moveto",function(m,l){h.position.date=l;k.render()});j.off("gantt-changeView").on("gantt-changeView",function(m,l){h.view=l;k.render()});j.off("gantt-filterBy").on("gantt-filterBy",function(m,l){h.filter=l;k.render()});j.off("gantt-collapse").on("gantt-collapse",function(){if(h.mode==="collapsed"){h.mode="regular"}else{h.mode="collapsed"}k.render()});d(".jg-project").off().on("mouseenter mouseleave",function(l){if(l.type==="mouseenter"){d(this).find(".jg-tasks").animate({top:19},75)}else{d(this).find(".jg-tasks").animate({top:0},50)}})},isBetween:function(k,h,j){return(k<=h&&h<=j)}};d.fn[c]=function(j,h){return this.each(function(){if(!d.data(this,"plugin_"+c)){d.data(this,"plugin_"+c,new e(this,j,h))}})}})(jQuery,window,document);