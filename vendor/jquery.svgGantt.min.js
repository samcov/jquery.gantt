(function(d,b,a,f){var c="svgGantt",e={mode:"regular",modes:{regular:{scale:2,paddingX:2,paddingY:1,showContent:true},collapsed:{scale:0.3,paddingX:0,paddingY:0.3,showContent:false}},position:{date:null,top:0},view:"month",views:{week:{grid:{color:"#DDD",x:150,y:10},format:"MMM, DD",labelEvery:"day",preloadDays:150},month:{grid:{color:"#DDD",x:42,y:10},format:"MMM, DD",labelEvery:"day",preloadDays:150},year:{grid:{color:"#DDD",x:13,y:10},format:"MMM",labelEvery:"month",preloadDays:150}}};function g(m,l,h){var n=this;n.container=d(m);n.options=d.extend({},e,h);n.projects=l;n.init()}g.prototype={init:function(){var h=this;h.parseProjects();h.createUI();h.render()},render:function(){var h=this;console.time("render time");h.clearUI();h.setTimeframe();h.setActiveProjects();h.drawGrid();h.setPosition();h.drawLabels();h.createElements();h.arrangeElements();h.dragInit();h.createEvents();console.timeEnd("render time")},parseProjects:function(){var l=this,h=l.projects,m=null;for(i=0;i<h.length;i++){m=h[i];if(isNaN(m.startDate)){m.startDate=moment(m.startDate).unix();m.endDate=moment(m.endDate).unix()}}h.sort(function(o,n){return o.startDate-n.startDate})},createUI:function(){var h=this,m=h.container,l="";l='<div class="sg-labels"></div><div class="sg-content"></div><canvas class="sg-grid" style="display: none;"></canvas>';m.css({overflow:"hidden"}).append(l);h.labels=m.find(".sg-labels");h.content=m.find(".sg-content");h.grid=m.find(".sg-grid")},clearUI:function(){var h=this;h.content.html("");h.labels.html("")},setTimeframe:function(){var n=this,m=n.options,q=n.container,l=m.position.date,o=q.width(),p=o*3,h=m.views[m.view].grid.x;n.curMoment=l?moment(l):moment();n.daysInGrid=Math.floor(p/h);n.startMoment=moment(n.curMoment).subtract("days",Math.floor(o/h));n.endMoment=moment(n.startMoment).add("days",n.daysInGrid)},setActiveProjects:function(){var p=this,t=p.options,q=t.views[t.view],o=p.projects;var n=(q.preloadDays*24*60*60),r=p.startMoment.unix()-n,h=moment(p.startMoment).add("days",p.daysInGrid).unix()+n;p.activeProjects=[];for(i=0;i<o.length;i++){var s=o[i],l=p.isBetween(r,s.startDate,h),m=p.isBetween(r,s.endDate,h);if(l||m){s.ganttRow=0;p.activeProjects.push(s)}}},drawGrid:function(){var p=this,o=this.options,n=p.grid[0],m=n.getContext("2d"),l=o.views[o.view],h=l.grid.x,q=l.grid.y;n.height=q;n.width=h;m.moveTo(h-0.5,-0.5);m.lineTo(h-0.5,q-0.5);m.lineTo(-0.5,q-0.5);m.strokeStyle=l.grid.color;m.stroke();data=n.toDataURL("image/jpg");p.content.css({background:"url("+data+")"})},setPosition:function(){var n=this,l=n.options,q=n.container,o=q.width(),h=l.views[l.view].grid.x,p=o*3,m=-(Math.floor(o/h)*h);n.content.css({height:q.height()*2,marginLeft:m,position:"relative",marginTop:l.position.top,width:p});n.labels.css({left:m,width:p})},drawLabels:function(){var o=this,t=o.options,r=t.views[t.view],p=r.grid.x,n=[];for(var m=0;m<o.daysInGrid;m++){var q=moment(o.startMoment).add("days",m),l=false;if(r.labelEvery==="month"){if(q.format("D")==="1"){l=true}}else{l=true}if(l){var h=q.format(r.format),s='<div class="sg-label" style="left:'+(p*m)+"px;width:"+p+'px;"><div class="sg-'+t.view+'">'+h+"</div></div>";n.push(s)}}o.labels.append(n.join(""))},createElements:function(){var t=this,y=t.options,s=y.modes[y.mode],v=y.views[y.view],u=v.grid.x,q=t.activeProjects,l=[];el_height=v.grid.y*s.scale-1;for(i=0;i<q.length;i++){var w=q[i],n=moment.unix(w.startDate),r=moment.unix(w.endDate),h=r.diff(n,"days")+1,p=n.diff(t.startMoment,"days"),m=h*u-2,o=p*u;l.push('<div class="sg-project" style="height:'+el_height+"px;left:"+o+"px;top: -30px;width:"+m+'px;">');l.push('<div class="sg-data" style="background:'+w.color+";height:"+el_height+"px;width:"+m+'px;">');if(s.showContent){l.push('<img class="sg-icon" src="'+w.iconURL+'" style="height: '+el_height+";width: "+el_height+';" />');l.push('<div class="sg-name" style="width: '+(m-el_height-8)+'px;">'+w.name+"</div>");l.push('<div class="sg-tasks">');for(j=0;j<w.tasks.length;j++){var x=w.tasks[j],o=moment(n).diff(x.date,"days")*u;l.push('<div class="sg-task" style="left:'+o+'px;"></div>')}l.push("</div></div>")}else{l.push("</div>")}l.push("</div>")}t.content.append(l.join(""))},arrangeElements:function(B){var E=this,n=E.options,r=n.modes[n.mode],w=E.content.children(),y=n.views[n.view].grid.y,v=y*r.paddingY,A=r.paddingX*(24*60*60),l=y*r.scale,q=E.activeProjects;for(var z=0;z<q.length;z++){var s=q[z],h=s.startDate-A,x=s.endDate+A,D=d(w[z]),p=0,o=[];for(var u=0;u<z;u++){var m=q[u],t=m.startDate,C=m.endDate;if(E.isBetween(t,h,C)){o.push(m.ganttRow)}else{if(E.isBetween(h,C,x)){o.push(m.ganttRow)}else{if(E.isBetween(t,x,C)){o.push(m.ganttRow)}else{if(E.isBetween(h,t,x)){o.push(m.ganttRow)}}}}}o.sort(function(G,F){return G-F});for(k=0;k<o.length;k++){usedRow=o[k];if(p===usedRow){p++}}s.ganttRow=p;attributes={top:v+(p*(l+v))-1,zIndex:5000-(p*10)};if(B){D.animate(attributes)}else{D.css(attributes)}}},dragInit:function(){var o=this,n=o.options,m=o.content,h=n.views[n.view].grid.x,l=container={x:0,y:0},q=draggingX=draggingY=false,r=curMoment=null,p=8;m.off().on("mousedown mousemove mouseup",function(u){if(u.type==="mousedown"){q=true;l={x:u.pageX,y:u.pageY};container={x:parseInt(m.css("margin-left")),y:parseInt(m.css("margin-top"))};curDayOffset=Math.round(parseInt(m.css("margin-left"))/h);r=moment(o.startMoment).subtract("days",curDayOffset)}else{if(u.type==="mousemove"&&q){if(!draggingX&&!draggingY){if(Math.abs(u.pageX-l.x)>p){draggingX=true}else{if(Math.abs(u.pageY-l.y)>p){draggingY=true}}}else{if(draggingX){var t=container.x+(u.pageX-l.x);m.css({marginLeft:t});o.labels.css({left:t})}else{var s=container.y+(u.pageY-l.y);if(s>0){s=0}m.css({marginTop:s})}}}else{if(u.type==="mouseup"){q=draggingX=draggingY=false;curDayOffset=Math.round(parseInt(m.css("margin-left"))/h);curMoment=moment(o.startMoment).subtract("days",curDayOffset);if(curMoment.format("MM DD")!=r.format("MM DD")){n.position.date=curMoment;n.position.top=parseInt(m.css("margin-top"));o.render()}}}}})},createEvents:function(){var l=this,h=l.options,m=l.container;m.off("gantt-changeView").on("gantt-changeView",function(o,n){h.view=n;l.render()});m.off("gantt-collapse").on("gantt-collapse",function(){if(h.mode==="collapsed"){h.mode="regular"}else{h.mode="collapsed"}l.render()})},isBetween:function(m,h,l){return(m<=h&&h<=l)}};d.fn[c]=function(l,h){return this.each(function(){if(!d.data(this,"plugin_"+c)){d.data(this,"plugin_"+c,new g(this,l,h))}})}})(jQuery,window,document);