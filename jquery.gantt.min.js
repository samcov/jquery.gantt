(function(d,b,a,g){var c="gantt",f={filter:{},mode:"regular",modes:{regular:{scale:2,paddingX:2,paddingY:1,showContent:true},huge:{scale:4,paddingX:2,paddingY:1,showContent:true},collapsed:{scale:0.3,paddingX:0,paddingY:0.3,showContent:false}},position:{date:null,top:0},view:"year",views:{week:{grid:{color:"#DDD",x:150,y:10},format:"MMM DD",labelEvery:"day",preloadDays:30,dayOffset:1,highlightDays:7},month:{grid:{color:"#DDD",x:42,y:10},format:"MMM DD",labelEvery:"day",preloadDays:30,dayOffset:3,highlightDays:10},year:{grid:{color:"#DDD",x:13,y:10},format:"MMM",labelEvery:"month",preloadDays:30,dayOffset:5,highlightDays:10}}};function e(j,k,h){var l=this;l.container=d(j);l.options=d.extend({},f,h);l.projects=k.projects;l.tasks=k.tasks;l.init()}e.prototype={init:function(){var h=this;h.parseData();h.createUI();h.render()},parseData:function(){var j=this.projects,l=this.tasks,k=null,h=null;for(i=0;i<j.length;i++){k=j[i];if(isNaN(k.startDate)){k.startDate=moment(k.startDate).unix();k.endDate=moment(k.endDate).unix()}k.ganttRow=0}j.sort(function(n,m){return n.startDate-m.startDate});for(i=0;i<l.length;i++){h=l[i];if(isNaN(h.date)){h.date=moment(h.date).unix()}}l.sort(function(n,m){return n.date-m.date})},createUI:function(){var k=this,j=k.container,h='<div class="jg-viewport"><div class="jg-timeline"><div class="jg-dates"></div><div class="jg-tasks"></div><div class="jg-content-wrap"><div class="jg-glow-top"></div><div class="jg-content"></div><div class="jg-glow-bottom"></div></div></div><div class="jg-playhead"></div><canvas class="jg-grid"></canvas></div>';j.empty().append(h);k.contentWrap=j.find(".jg-content-wrap");k.glowTop=j.find(".jg-glow-top");k.glowBottom=j.find(".jg-glow-bottom");k.content=j.find(".jg-content");k.tasksContent=j.find(".jg-tasks");k.dates=j.find(".jg-dates");k.grid=j.find(".jg-grid");k.playhead=j.find(".jg-playhead");k.timeline=j.find(".jg-timeline");k.viewport=j.find(".jg-viewport")},render:function(){var h=this;console.time("render time");h.clearUI();h.setGlobals();h.setActiveProjects();h.drawGrid();h.setPosition();h.drawLabels();h.createElements();h.dragInit();h.setNamePositions();h.setVerticalHints();h.createEvents();console.timeEnd("render time")},clearUI:function(){var h=this;h.content.empty();h.dates.empty();h.tasksContent.empty()},setGlobals:function(){var m=this,k=m.options,l=m.container;m.mode=k.modes[k.mode];m.view=k.views[k.view];m.containerWidth=l.width()+((m.view.dayOffset+1)*m.view.grid.x);m.timelineWidth=m.containerWidth*3;m.viewportHeight=l.height()-m.dates.height()-m.tasksContent.height();var j=k.position.date,h=m.view.grid.x;m.daysUntilCurrent=Math.floor(m.containerWidth/h);m.daysInGrid=Math.floor(m.timelineWidth/m.view.grid.x);m.curMoment=j?moment(j):moment();m.startMoment=moment(m.curMoment).subtract("days",m.daysUntilCurrent);m.endMoment=moment(m.startMoment).add("days",m.daysInGrid);m.dayOffset=m.view.dayOffset*h;m.settingNamePositions=false},setActiveProjects:function(){var s=this,w=s.options,t=s.view,r=s.projects,v,q=s.tasks,l,o=(t.preloadDays*24*60*60),u=s.startMoment.unix()-o,h=s.endMoment.unix()+o;s.activeProjects=[];for(i=0;i<r.length;i++){v=r[i];var k=s.isBetween(u,v.startDate,h),m=s.isBetween(u,v.endDate,h),n=true;for(filter in w.filter){n=false;theFilter=w.filter[filter];for(var p=0;p<theFilter.length;p++){if(v[filter]===theFilter[p]){n=true}}}if((k||m)&&n){s.activeProjects.push(v)}}s.activeTasks=[];for(i=0;i<q.length;i++){l=q[i];if(s.isBetween(u,l.date,h)){s.activeTasks.push(l)}}},drawGrid:function(){var n=this,m=this.options,l=n.grid[0],k=l.getContext("2d"),j=m.views[m.view],h=j.grid.x,o=j.grid.y;l.height=o;l.width=h;k.moveTo(h-0.5,-0.5);k.lineTo(h-0.5,o-0.5);k.lineTo(-0.5,o-0.5);k.strokeStyle=j.grid.color;k.stroke();data=l.toDataURL("image/jpg");n.content.css({background:"url("+data+")"})},setPosition:function(){var o=this,k=o.options,j=o.view,h=j.grid.x,n=o.dayOffset,l=-(o.daysUntilCurrent*h)+n,m=n;o.timeline.css({left:l,width:o.timelineWidth});o.glowBottom.css({top:o.viewportHeight-o.glowBottom.height()});o.playhead.css({left:m,width:(j.highlightDays*h)})},drawLabels:function(){var l=this,q=l.options,n=l.view,k=n.grid.x,j=[],o=null;for(var h=0;h<l.daysInGrid;h++){var m=moment(l.startMoment).add("days",h),p=false;switch(n.labelEvery){case"month":if(m.format("D")==="1"){p=n.format}break;default:p=n.format}if(p&&moment().format("YYYY")!=m.format("YYYY")){p+=", YYYY"}if(p){o='<div class="jg-label" style="left:'+(k*h)+"px;width:"+k+'px;"><div class="jg-'+q.view+'">'+m.format(p)+"</div></div>";j.push(o)}}l.dates.append(j.join(""))},createElements:function(){var z=this,D=z.options,v=z.mode,o=z.view,N=o.grid.x,L=o.grid.y,y=z.activeProjects,F=z.activeTasks,q=[],J=L*v.scale-1,n=L*v.paddingY,p=v.paddingX*(24*60*60),U=0;for(var O=0;O<y.length;O++){var h=y[O],u=moment.unix(h.startDate),C=moment.unix(h.endDate),R=C.diff(u,"days")+1,E=u.diff(z.startMoment,"days"),w=R*N-1,r=E*N,I,S=u.unix()-p,m=C.unix()+p,A=0,T=[];for(var M=0;M<O;M++){var x=y[M],B=x.startDate,l=x.endDate;if(z.isBetween(B,S,l)){T.push(x.ganttRow)}else{if(z.isBetween(S,l,m)){T.push(x.ganttRow)}else{if(z.isBetween(B,m,l)){T.push(x.ganttRow)}else{if(z.isBetween(S,B,m)){T.push(x.ganttRow)}}}}}T.sort(function(k,j){return k-j});for(var K=0;K<T.length;K++){usedRow=T[K];if(A===usedRow){A++}}if(A>U){U=A}h.ganttRow=A;I=n+(A*(J+n+1));q.push('<div class="jg-project" style="height:'+J+"px;left:"+r+"px;top: "+I+"px;z-index:"+(1000-A)+";width:"+w+'px;"><div class="jg-data" style="background:'+h.color+';">');if(v.showContent){q.push('<div class="jg-name">');if(h.iconURL){q.push('<img class="jg-icon" src="'+h.iconURL+'" />')}q.push(h.name+"<span>"+u.format("MMMM D")+" - "+C.format("MMMM D")+"</span></div>")}q.push("</div>");if(v.showContent){q.push('<div class="jg-tasks">');var Q=(N/2)-2;for(M=0;M<h.tasks.length;M++){console.log("Yep");var H=h.tasks[M],G=(moment(u).diff(H.date,"days",true)*N)+Q;q.push('<div class="jg-task" style="left:'+G+'px;"></div>')}q.push("</div>")}q.push("</div>")}U+=2;content_height=(U*L)+(U*J)+L;content_offset=-(z.content.position().top);if(content_height<z.viewportHeight){content_height=z.viewportHeight;z.content.animate({top:0},100)}else{if(content_height<content_offset+z.viewportHeight){z.content.animate({top:z.viewportHeight-content_height},100)}}z.content.append(q.join("")).css({height:content_height});q=[];taskHeight=z.tasksContent.height();for(var O=0;O<F.length;O++){var H=F[O],t=4,P=moment.unix(H.date),E=P.diff(z.startMoment,"days"),r=E*N;for(var M=O+1;M<F.length;M++){nextTask=F[M];if(nextTask.date===H.date){if(t+4<taskHeight){t+=4}O=M}else{break}}var s=(taskHeight/2)-(t/2)-1;q.push('<div class="task" style="left:'+r+"px;height:"+t+"px;width:"+t+"px;border-radius:"+t+"px;top:"+s+'px;"></div>')}z.tasksContent.append(q.join(""))},dragInit:function(){var p=this,t=p.options,h=p.content,k=p.timeline,m=p.viewportHeight,q=p.view,n=q.grid.x,o=positions={x:0,y:0},s=draggingX=draggingY=false,j=curMoment=null,r=null,l=10;p.viewport.off().on("mousedown mousemove mouseup",function(y){if(y.type==="mousedown"){s=true;o={x:y.pageX,y:y.pageY};positions={x:k.position().left,y:p.content.position().top};var v=Math.round(k.position().left/n);j=moment(p.startMoment).subtract("days",v);r=h.height()}else{if(y.type==="mousemove"&&s){if(!draggingX&&!draggingY){if(Math.abs(y.pageX-o.x)>l){draggingX=true}else{if(Math.abs(y.pageY-o.y)>l){draggingY=true}}}else{if(draggingX){var x=positions.x+(y.pageX-o.x);k.css({left:x});p.setNamePositions()}else{var w=positions.y+(y.pageY-o.y),u=-(r-m);if(w>0){w=0}if(w<u){w=u}h.css({top:w});p.setVerticalHints()}}}else{if(y.type==="mouseup"){s=draggingX=draggingY=false;var v=Math.round((k.position().left-p.dayOffset)/n);curMoment=moment(p.startMoment).subtract("days",v);if(moment(curMoment).subtract("days",p.view.dayOffset).format("MM DD")!=j.format("MM DD")){t.position.date=curMoment;t.position.top=p.content.position().top;p.render()}}}}})},setNamePositions:function(){var p=this;if(p.mode.showContent){var h=d(".jg-project"),q=-(p.timeline.position().left),j=false;for(var m=0;m<h.length;m++){var n=d(h[m]),l=n.position().left;if(l<q+500){var o=n.width();if(l+o>q-500){var r=n.find(".jg-name"),k=o-(q-l);if(k<=o){r.width(k)}else{r.width(o)}}j=true}else{if(j){return false}}}}},setVerticalHints:function(){var l=this,k=-(l.content.position().top),h=l.content.height()-k-l.viewportHeight,j=40;if(k>j){k=j}if(h>j){h=j}k=k/10;h=h/10;l.glowTop.css({boxShadow:"inset 0 "+k+"px "+(k*2)+"px 0 rgba(0,0,0,0.45)"});l.glowBottom.css({boxShadow:"inset 0 -"+h+"px "+(h*2)+"px 0 rgba(0,0,0,0.45)"})},createEvents:function(){var k=this,h=k.options,j=k.container;j.off("gantt-moveto").on("gantt-moveto",function(m,l){h.position.date=l;k.render()});j.off("gantt-changeView").on("gantt-changeView",function(m,l){h.view=l;k.render()});j.off("gantt-filterBy").on("gantt-filterBy",function(m,l){h.filter=l;k.render()});j.off("gantt-changeMode").on("gantt-changeMode",function(l,m){h.mode=m;k.render()});d(".jg-project").off().on("mouseenter mouseleave",function(l){if(l.type==="mouseenter"){d(this).find(".jg-tasks").animate({bottom:-15},75)}else{d(this).find(".jg-tasks").animate({bottom:0},50)}})},isBetween:function(k,h,j){return(k<=h&&h<=j)}};d.fn[c]=function(j,h){return this.each(function(){if(!d.data(this,"plugin_"+c)){d.data(this,"plugin_"+c,new e(this,j,h))}})}})(jQuery,window,document);