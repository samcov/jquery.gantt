(function(d,b,a,f){var c="svgGantt",e={currentDate:null,grid:{color:"#DDD",offsetY:0},mode:"regular",modes:{regular:{scale:2,paddingX:2,paddingY:1,showContent:true},collapsed:{scale:0.3,paddingX:0,paddingY:0.2,showContent:false}},view:"month",views:{week:{gridX:150,gridY:10,format:"MMM, DD",labelEvery:"day"},month:{gridX:42,gridY:10,format:"MMM, DD",labelEvery:"day"},year:{gridX:13,gridY:10,format:"MMM",labelEvery:"month"}}};function g(j,m,h){var l=this;l.container=d(j);l.options=d.extend({},e,h);l.objects=m;l.init()}g.prototype={init:function(){var j=this,h=j.options;j.createUI();j.createEvents();j.drawGrid();j.setTimePosition();j.sortObjects();j.drawLabels();j.dragInit();j.createElements();j.arrangeElements()},sortObjects:function(){var o=this;for(i=0;i<o.objects.length;i++){m=o.objects[i];if(typeof m.startDate!="number"){m.startDate=moment(m.startDate).unix();m.endDate=moment(m.endDate).unix()}}o.objects.sort(function(r,q){isBefore=r.startDate-q.startDate;if(!isBefore){isBefore=r.id-q.id}return isBefore});o.liveObjects=[];var p=(120*24*60*60),l=o.startMoment.unix()-p,j=moment(o.startMoment).add("days",o.daysInGrid).unix()+p;for(i=0;i<o.objects.length;i++){var m=o.objects[i],n=o.isBetween(l,m.startDate,j),h=o.isBetween(l,m.endDate,j);if(n||h){m.ganttRow=0;o.liveObjects.push(m)}}},createUI:function(){var j=this,h=j.options,l=j.container;l.html("").css({overflow:"hidden"});d('<div class="sg-labels"></div>').appendTo(l);j.labels=l.find(".sg-labels");d('<div class="sg-content"></div>').appendTo(l);j.content=l.find(".sg-content");d('<canvas class="sg-grid"></canvas>').appendTo(l).hide();j.grid=l.find(".sg-grid")},createEvents:function(){var j=this,h=j.options,l=j.container;l.off("gantt-changeView").on("gantt-changeView",function(n,m){h.view=m;j.init()});l.off("gantt-collapse").on("gantt-collapse",function(){if(h.mode==="collapsed"){h.mode="regular"}else{h.mode="collapsed"}j.init()})},drawGrid:function(){var o=this,n=this.options,m=o.grid[0],l=m.getContext("2d"),j=n.views[n.view],h=j.gridX,p=j.gridY;m.height=p;m.width=h;l.moveTo(h-0.5,-0.5);l.lineTo(h-0.5,p-0.5);l.lineTo(-0.5,p-0.5);l.strokeStyle=n.grid.color;l.stroke();data=m.toDataURL("image/jpg");o.content.css({background:"url("+data+")"})},setTimePosition:function(){var l=this,s=l.options,p=s.views[s.view],r=l.container,q=r.width(),n=q*3,m=p.gridX,j=-(Math.floor(q/m)*m),h=s.currentDate,o=h?moment(h):moment();l.startMoment=o.subtract("days",Math.floor(q/m));l.daysInGrid=n/m;l.content.css({height:r.height()*2,marginLeft:j,position:"relative",marginTop:s.grid.offsetY,width:n});l.labels.css({left:j,width:n})},drawLabels:function(){var l=this,s=l.options,p=s.views[s.view],r=l.daysInGrid,m=p.gridX;for(var j=0;j<r;j++){var o=moment(l.startMoment).add("days",j),h=false;if(p.labelEvery==="month"){if(o.format("D")==="1"){h=true}}else{h=true}if(h){var q=o.format(p.format),n=d('<div class="sg-label"><div class="sg-'+s.view+'">'+q+"</div></div>");l.labels.append(n);n.css({left:m*j,position:"absolute",textAlign:"center",top:5,width:m})}}},dragInit:function(){var n=this,m=n.options,l=container={x:0,y:0},p=false,h=m.views[m.view].gridX,j=n.content,q=curMoment=null,o=0;j.off().on("mousedown mousemove mouseup",function(r){if(r.type==="mousedown"){p=true;l={x:r.pageX,y:r.pageY};container={x:parseInt(j.css("margin-left")),y:parseInt(j.css("margin-top"))};curDayOffset=Math.round(parseInt(j.css("margin-left"))/h);q=moment(n.startMoment).subtract("days",curDayOffset);o=j.height()/2}else{if(r.type==="mousemove"&&p){marginLeft=container.x+(r.pageX-l.x);marginTop=container.y+(r.pageY-l.y);if(marginLeft>0){marginLeft=0}if(marginTop>0){marginTop=0}if(marginTop<=-(o)){marginTop=-(o)}j.css({marginLeft:marginLeft,marginTop:marginTop});n.labels.css({left:marginLeft})}else{if(r.type==="mouseup"){p=false;curDayOffset=Math.round(parseInt(j.css("margin-left"))/h);curMoment=moment(n.startMoment).subtract("days",curDayOffset);if(curMoment.format("MM DD")!=q.format("MM DD")){m.currentDate=curMoment;m.grid.offsetY=parseInt(j.css("margin-top"));n.init()}}}}})},createElements:function(){var s=this,z=s.options,u=z.views[z.view],t=u.gridX,r=z.modes[z.mode],y=s.liveObjects;for(i=0;i<y.length;i++){var p=y[i],w=d('<div class="sg-object"></div>'),j=d('<img class="sg-icon" src="'+p.iconURL+'" />'),x=d('<div class="sg-name">'+p.name+"</div>"),m=moment.unix(p.startDate),q=moment.unix(p.endDate),h=q.diff(m,"days")+1,o=m.diff(s.startMoment,"days"),v=u.gridY*r.scale,l=h*t,n=o*t;if(r.showContent){w.append(j).append(x)}s.content.append(w);j.css({height:v,width:v});x.css({width:l-j.outerWidth(true)});w.css({background:p.color,height:v,left:n,top:-30,width:l})}},arrangeElements:function(D){var H=this,o=H.options,r=o.modes[o.mode],s=H.content.children(),z=o.views[o.view].gridY,x=z*r.paddingY,B=r.paddingX*(24*60*60),E=z*r.scale,h=H.liveObjects;for(var A=0;A<h.length;A++){var u=h[A],l=u.startDate-B,y=u.endDate+B,G=d(s[A]),q=0,p=[];for(var w=0;w<A;w++){var I=h[w],m=I.startDate,n=I.endDate,F=H.isBetween(m,l,n),C=H.isBetween(m,y,n),v=H.isBetween(l,m,y),t=H.isBetween(l,n,y);if(F||C||v||t){p.push(I.ganttRow)}}p.sort(function(J,j){return J-j});for(k=0;k<p.length;k++){usedRow=p[k];if(q===usedRow){q++}}u.ganttRow=q;attributes={top:x+(q*(E+x))};if(D){G.animate(attributes)}else{G.css(attributes)}}},isBetween:function(l,h,j){return(l<=h&&h<=j)}};d.fn[c]=function(j,h){return this.each(function(){if(!d.data(this,"plugin_"+c)){d.data(this,"plugin_"+c,new g(this,j,h))}})}})(jQuery,window,document);