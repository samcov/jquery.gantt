(function(a){function g(b,c,d){var e=this;e.container=a(b),e.options=a.extend({},f,d),e.data=c,e.init()}var e="gantt",f={filter:{},mode:"regular",modes:{regular:{scale:2,paddingX:2,paddingY:1,showContent:!0},huge:{scale:4,paddingX:2,paddingY:1,showContent:!0},collapsed:{scale:.3,paddingX:0,paddingY:.3,showContent:!1}},position:{date:null,top:0},view:"year",views:{week:{grid:{color:"#DDD",x:150,y:10},format:"MMM DD",labelEvery:"day",preloadDays:60,dayOffset:1,highlightDays:7},month:{grid:{color:"#DDD",x:42,y:10},format:"MMM DD",labelEvery:"day",preloadDays:30,dayOffset:3,highlightDays:10},year:{grid:{color:"#DDD",x:13,y:10},format:"MMM",labelEvery:"month",preloadDays:0,dayOffset:5,highlightDays:10}}};g.prototype={init:function(){var a=this;a.parseData(),a.createUI(),a.render()},parseData:function(){for(var d,e,a=this,b=a.data.projects,c=a.data.tasks,f=0;b.length>f;f++){d=b[f],isNaN(d.startDate)&&(d.startDate=moment(d.startDate).unix(),d.endDate=moment(d.endDate).unix());for(var g=0;d.tasks.length>g;g++)e=d.tasks[g],isNaN(e.date)&&(e.date=moment(e.date).unix());d.ganttRow=0}b.sort(function(a,b){return a.startDate-b.startDate});for(var f=0;c.length>f;f++)e=c[f],isNaN(e.date)&&(e.date=moment(e.date).unix());c.sort(function(a,b){return a.date-b.date})},createUI:function(){var a=this,b=a.container,c=a.elements={},d='<div class="jg-viewport"><div class="jg-timeline"><div class="jg-dates"></div><div class="jg-tasks"></div><div class="jg-content-wrap"><div class="jg-glow-top"></div><div class="jg-content"></div><div class="jg-glow-bottom"></div></div></div><div class="jg-scrub-timeframe"></div><div class="jg-scrub"><div class="jg-scrub-inner"></div></div><canvas class="jg-grid"></canvas></div>';b.empty().append(d),c.viewport=b.find(".jg-viewport"),c.timeline=b.find(".jg-timeline"),c.dates=b.find(".jg-dates"),c.tasks=b.find(".jg-tasks"),c.contentWrap=b.find(".jg-content-wrap"),c.glowTop=b.find(".jg-glow-top"),c.content=b.find(".jg-content"),c.glowBottom=b.find(".jg-glow-bottom"),c.scrubTimeframe=b.find(".jg-scrub-timeframe"),c.scrub=b.find(".jg-scrub"),c.grid=b.find(".jg-grid")},render:function(){var a=this;console.time("render time"),a.clearUI(),a.setGlobals(),a.setActiveProjects(),a.drawGrid(),a.setPosition(),a.drawLabels(),a.createElements(),a.dragInit(),a.setNamePositions(),a.setVerticalHints(),a.createEvents(),console.timeEnd("render time")},clearUI:function(){var a=this.elements;a.content.empty(),a.dates.empty(),a.tasks.empty()},setGlobals:function(){var a=this,b=a.options,c=a.elements,d=a.container;a.mode=b.modes[b.mode],a.view=b.views[b.view];var e=a.view.grid.x,f=b.position.date;a.scrubOffset=(a.view.dayOffset+1)*e,a.containerWidth=d.width()+a.scrubOffset,a.timelineWidth=3*a.containerWidth,a.viewportHeight=d.height()-c.dates.height()-c.tasks.height(),a.glowHeight=c.glowBottom.height(),a.tasksHeight=c.tasks.height(),a.daysUntilCurrent=Math.floor(a.containerWidth/e),a.daysInGrid=Math.floor(a.timelineWidth/e),a.curMoment=f?moment(f):moment(),a.startMoment=moment(a.curMoment).subtract("days",a.daysUntilCurrent),a.endMoment=moment(a.startMoment).add("days",a.daysInGrid),a.dayOffset=a.view.dayOffset*e},setActiveProjects:function(){for(var a=this,b=a.options,c=a.view,d=a.data.projects,e=a.data.tasks,f=60*60*24*c.preloadDays,g=a.startMoment.unix()-f,h=a.endMoment.unix()+f,i=a.data.activeProjects=[],j=0;d.length>j;j++){var k=d[j],l=a.isBetween(g,k.startDate,h),m=a.isBetween(g,k.endDate,h);o=!0;for(var n in b.filter)for(var o=!1,p=b.filter[n],q=0;p.length>q;q++)k[n]===p[q]&&(o=!0);o&&(l||m)&&i.push(k)}activeTasks=a.data.activeTasks=[];for(var j=0;e.length>j;j++){var r=e[j];a.isBetween(g,r.date,h)&&activeTasks.push(r)}},drawGrid:function(){var a=this,c=(this.options,a.elements),d=c.grid[0],e=d.getContext("2d"),f=a.view,g=f.grid.x,h=f.grid.y;d.height=h,d.width=g,e.moveTo(g-.5,-.5),e.lineTo(g-.5,h-.5),e.lineTo(-.5,h-.5),e.strokeStyle=f.grid.color,e.stroke(),data=d.toDataURL("image/jpg"),c.content.css({background:"url("+data+")"})},setPosition:function(){var a=this,c=(a.options,a.elements),d=a.view,e=d.grid.x,f=a.dayOffset,g=-(a.daysUntilCurrent*e)+f,h=f;c.timeline.css({left:g,width:a.timelineWidth}),c.glowBottom.css({top:a.viewportHeight-a.glowHeight}),c.scrub.css({left:h}),c.scrubTimeframe.css({left:h,width:d.highlightDays*e})},drawLabels:function(){for(var a=this,b=a.options,c=a.view,d=c.grid.x,e=[],f=0;a.daysInGrid>f;f++){var g=moment(a.startMoment).add("days",f),h=!1;switch(c.labelEvery){case"month":"1"===g.format("D")&&(h=c.format);break;default:h=c.format}if(h&&moment().format("YYYY")!=g.format("YYYY")&&(h+=", YYYY"),h){var i='<div class="jg-label" style="left:'+d*f+"px;width:"+d+'px;">'+'<div class="jg-'+b.view+'">'+g.format(h)+"</div>"+"</div>";e.push(i)}}a.elements.dates.append(e.join(""))},createElements:function(){var a=this,c=(a.options,a.elements),d=a.mode,e=a.view,f=e.grid.x,g=e.grid.y,h=a.data.activeProjects,i=a.data.activeTasks,j=[],k=g*d.scale-1,l=g*d.paddingY,m=86400*d.paddingX,n=0;i.length;for(var p=0;h.length>p;p++){for(var q=h[p],r=moment.unix(q.startDate),s=moment.unix(q.endDate),t=s.diff(r,"days")+1,u=r.diff(a.startMoment,"days"),v=t*f-1,w=u*f,x=r.unix()-m,y=s.unix()+m,z=0,A=[],B=0;p>B;B++){var C=h[B],D=C.startDate,E=C.endDate;a.isBetween(D,x,E)?A.push(C.ganttRow):a.isBetween(x,E,y)?A.push(C.ganttRow):a.isBetween(D,y,E)?A.push(C.ganttRow):a.isBetween(x,D,y)&&A.push(C.ganttRow)}A.sort(function(a,b){return a-b});for(var B=0;A.length>B;B++)usedRow=A[B],z===usedRow&&z++;z>n&&(n=z),q.ganttRow=z;var F=l+z*(k+l+1);j.push('<div class="jg-project" style="height:'+k+"px;"+"left:"+w+"px;"+"top: "+F+"px;"+"z-index:"+(1e3-z)+";"+"width:"+v+'px;">'+'<div class="jg-data" style="background:'+q.color+';">'),d.showContent&&(j.push('<div class="jg-name">'),q.iconURL&&j.push('<img class="jg-icon" src="'+q.iconURL+'" />'),j.push(q.name+"<span>"+r.format("MMMM D")+" - "+s.format("MMMM D")+"</span></div>")),j.push("</div>"),d.showContent&&(j.push('<div class="jg-tasks">'),j.push(a.createTasks(q.tasks,r,k)),j.push("</div>")),j.push("</div>")}n+=2,content_height=n*g+n*k+g,content_offset=-c.content.position().top,a.viewportHeight>content_height?(content_height=a.viewportHeight,c.content.animate({top:0},100)):content_offset+a.viewportHeight>content_height&&c.content.animate({top:a.viewportHeight-content_height},100),c.content.append(j.join("")).css({height:content_height}),c.tasks.append(a.createTasks(i,a.startMoment,a.tasksHeight))},dragInit:function(){var a=this,b=a.options,c=a.elements,d=a.viewportHeight,e=a.view,f=e.grid.x,g=positions={x:0,y:0},h=draggingX=draggingY=!1,i=curMoment=null,j=null,k=10;c.viewport.off().on("mousedown mousemove mouseup",function(e){if("mousedown"===e.type){h=!0,g={x:e.pageX,y:e.pageY},positions={x:c.timeline.position().left,y:c.content.position().top};var l=Math.round(c.timeline.position().left/f);i=moment(a.startMoment).subtract("days",l),j=c.content.height()}else if("mousemove"===e.type&&h)if(draggingX||draggingY)if(draggingX){var m=positions.x+(e.pageX-g.x);c.timeline.css({left:m}),a.setNamePositions()}else{var n=positions.y+(e.pageY-g.y),o=-(j-d);n>0&&(n=0),o>n&&(n=o),c.content.css({top:n}),a.setVerticalHints()}else Math.abs(e.pageX-g.x)>k?draggingX=!0:Math.abs(e.pageY-g.y)>k&&(draggingY=!0);else if("mouseup"===e.type){h=draggingX=draggingY=!1;var l=Math.round((c.timeline.position().left-a.dayOffset)/f);curMoment=moment(a.startMoment).subtract("days",l),moment(curMoment).subtract("days",a.view.dayOffset).format("MM DD")!=i.format("MM DD")&&(b.position.date=curMoment,b.position.top=c.content.position().top,a.render())}})},setNamePositions:function(){var b=this;if(b.mode.showContent)for(var c=a(".jg-project"),d=-b.elements.timeline.position().left,e=!1,f=0;c.length>f;f++){var g=a(c[f]),h=g.position().left;if(d+500>h){var i=g.width();if(h+i>d-500){var j=g.find(".jg-name"),k=i-(d-h);i>=k?j.width(k):j.width(i)}e=!0}else if(e)return!1}},createEvents:function(){var b=this,c=b.options,d=b.container;d.off("gantt-moveto").on("gantt-moveto",function(a,d){c.position.date=d,b.render()}),d.off("gantt-changeView").on("gantt-changeView",function(a,d){c.view=d,b.render()}),d.off("gantt-filterBy").on("gantt-filterBy",function(a,d){c.filter=d,b.render()}),d.off("gantt-changeMode").on("gantt-changeMode",function(a,d){c.mode=d,b.render()}),d.find(".jg-project").off().on("mouseenter mouseleave",function(b){"mouseenter"===b.type?a(this).find(".jg-tasks").show():a(this).find(".jg-tasks").hide()})},setVerticalHints:function(){var a=this,b=a.elements,c=-b.content.position().top,d=b.content.height()-c-a.viewportHeight,e=40;c>e&&(c=e),d>e&&(d=e),c/=10,d/=10,b.glowTop.css({boxShadow:"inset 0 "+c+"px "+2*c+"px 0 rgba(0,0,0,0.45)"}),b.glowBottom.css({boxShadow:"inset 0 -"+d+"px "+2*d+"px 0 rgba(0,0,0,0.45)"})},isBetween:function(a,b,c){return b>=a&&c>=b},createTasks:function(a,b,c){for(var d=this,e=d.view.grid.x,f=a.length,g=[],h=0;f>h;h++){for(var i=a[h],j=4,k=moment.unix(i.date),l=Math.abs(k.diff(b,"days")),m=l*e,n=h+1;f>n;n++){var o=a[n];if(o.date!==i.date)break;c>j+2&&e>j+2&&(j+=2),h=n}task_top=c/2-j/2-1,m=m+e/2-j/2,g.push('<div class="jg-task" data-id="'+n+'" '+'style="'+"left:"+m+"px;"+"height:"+j+"px;"+"width:"+j+"px;"+"border-radius:"+j+"px;"+"top:"+task_top+"px;"+'"></div>')}return g.join("")}},a.fn[e]=function(b,c){return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new g(this,b,c))})}})(jQuery,window,document);